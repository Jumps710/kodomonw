<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寄付の報告</title>
    <script src="https://static.line-scdn.net/liff/edge/versions/2.20.0/sdk.js"></script>
    <script src="https://unpkg.com/vconsole/dist/vconsole.min.js"></script>
    <script>
        var vConsole = new VConsole();
    </script>
    <link rel="stylesheet" href="style.css">
    <style>
        .custom-file-label {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            width: 100%;
            margin-bottom: 5px;
        }

        .file-name {
            display: block;
            text-align: center;
            color: #555;
        }

        #submitDonation {
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            font-size: 18px;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            position: relative;
        }

        .close {
            color: #aaa;
            position: absolute;
            right: 10px;
            top: 5px;
            font-size: 28px;
            cursor: pointer;
        }

        textarea {
            height: 90px;
        }
    </style>
</head>
<body>

<form id="donationForm">
    <h1><span id="nickname"></span> さん、寄付の報告をしてください</h1>

    <div class="form-group">
        <label for="itemName">品名:</label>
        <input type="text" id="itemName" placeholder="お米、缶詰など">
    </div>

    <div class="form-group">
        <label for="donor">寄付元:</label>
        <input type="text" id="donor" placeholder="寄付元名">
    </div>

    <div class="form-group">
        <label for="message">メッセージ:</label>
        <textarea id="message" rows="3" placeholder="寄付の詳細や伝えたいことを記入してください（120文字以内）"></textarea>
    </div>

    <div class="form-group">
        <input type="file" id="image" hidden>
        <label for="image" class="custom-file-label">画像を選択</label>
        <span class="file-name">未選択</span>
    </div>

    <div id="photoPreview" class="photo-preview"></div>

    <div class="button-group">
        <button id="submitDonation">寄付を登録</button>
    </div>
</form>

<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>寄付の報告を送信しますか？</h2>
        <p><strong>品名:</strong> <span id="confirmItem"></span></p>
        <p><strong>寄付元:</strong> <span id="confirmDonor"></span></p>
        <p><strong>メッセージ:</strong> <span id="confirmMessage"></span></p>
        <div id="confirmImagePreview" class="photo-preview"></div>
        <button id="confirmSubmit">確定</button>
    </div>
</div>

<script>
    let userId, displayName, imageFileBase64;

    async function initLIFF() {
        await liff.init({ liffId: "2006996059-NjRq5Mro" });
        if (!liff.isLoggedIn()) {
            liff.login();
            return;
        }
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;
        document.getElementById("nickname").textContent = displayName;
    }

    document.getElementById("image").addEventListener("change", function(event) {
        const file = event.target.files[0];
        if (!file) return;

        document.querySelector(".file-name").textContent = file.name;
        const reader = new FileReader();
        reader.onload = function(e) {
            imageFileBase64 = e.target.result.split(",")[1];
            document.getElementById("photoPreview").innerHTML = `<img src="${e.target.result}" class="thumbnail">`;
        };
        reader.readAsDataURL(file);
    });

    document.getElementById("submitDonation").addEventListener("click", function(event) {
        event.preventDefault();
        if (!itemName.value || !donor.value || !message.value) {
            alert("すべての項目を入力してください");
            return;
        }
        confirmItem.textContent = itemName.value;
        confirmDonor.textContent = donor.value + " 様";
        confirmMessage.textContent = message.value;
        confirmImagePreview.innerHTML = photoPreview.innerHTML;
        confirmationModal.style.display = "block";
    });

    document.querySelector(".close").onclick = () => confirmationModal.style.display = "none";

    document.getElementById("confirmSubmit").onclick = async () => {
        confirmationModal.style.display = "none";
        const res = await fetch("YOUR_GAS_WEB_APP_URL", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action: "submitDonation", userId, nickname: displayName, itemName: itemName.value, donor: donor.value, message: message.value, imageBase64: imageFileBase64 })
        });
        const result = await res.json();
        alert(result.success ? "寄付の報告が完了しました！" : `送信に失敗しました: ${result.error}`);
        if (result.success) location.reload();
    };

    initLIFF();
</script>

</body>
</html>
